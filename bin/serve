#!/usr/bin/env php
<?php
/**
 * Shell script interface for launching the built-in webserver.
 *
 * Usage: server [-a|--approot[="..."]] [-p|--port[="..."]]
 *
 * PHP.Gt (http://php.gt)
 * @copyright Copyright â’¸ 2015 Bright Flair Ltd. (http://brightflair.com)
 * @license http://www.opensource.org/licenses/mit-license.php MIT
 */
use Gt\Cli\Server;
use Symfony\Component\Console\Input\InputDefinition;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Input\ArgvInput;

$cwd = getcwd();
$vendorAutoLoadFile = realpath(__DIR__ . "/../vendor/autoload.php");
if(!file_exists($vendorAutoLoadFile)) {
	// If this script exists within the vendor/brightflair/php.gt directory:
	$vendorAutoLoadFile = realpath(__DIR__ . "/../../../autoload.php");
	$cwd = realpath(__DIR__ . "/../../../..");
}
require($vendorAutoLoadFile);

$defaults = [
	"approot" => $cwd,
	"port" => 8080,
];

$definition = new InputDefinition([
	new InputArgument("approot", InputArgument::OPTIONAL),
	new InputOption("approot", "a", InputOption::VALUE_OPTIONAL,
		"Application root directory", $defaults["approot"]),
	new InputOption("port", "p", InputOption::VALUE_OPTIONAL,
		"Port to bind webserver to", $defaults["port"]),
]);

try {
	$input = new ArgvInput($argv, $definition);
	$approot = $input->getOption("approot");
	$overrideApproot = $input->getArgument("approot");
	if(!is_null($overrideApproot)) {
		$approot = "$approot/$overrideApproot";
	}
	// Change autoloaders so we are definitely using the current project's
	// dependencies (rather than the global PHP.Gt dependencies).
	$projectAutoloader = "$approot/vendor/autoload.php";
	if(!file_exists($projectAutoloader)) {
		// We must be running the bin/serve script manually...
		$projectAutoloader = $vendorAutoLoadFile;
	}

	if(!file_exists($projectAutoloader)) {
		echo "\nYour project must require PHP.Gt "
			. "as a dependency using composer.\n\n"
			. "See http://www.php.gt/docs/installation for more information.";
		exit(1);
	}
	require($projectAutoloader);
	new Server($input);
	exit(0);
}
catch(Exception $e) {
	echo "\nserver shell script usage:\n";
	echo $definition->getSynopsis();
	echo "\n\n";
	echo strip_tags($definition->asText());
	echo "\n";
	exit(1);
}